<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Inicio</title>
</head>
<body>
<button onclick="new Session().getTransferTxs()">Get Tx</button>
<br />
<button onclick="new Session().getTransferTxs()">Get all txs</button>
<br />
<button onclick="new Session().delete()">Delete sesi√≥n</button>
<script>
    class Request
    {
        attributes = null;
        body = null;
        headers = {
            Accept: this.constructor.HEADER_CONTENT_TYPE,
        };
        method = 'GET';

        static get HEADER_CONTENT_TYPE()
        {
            return '*/*';
        }



        getBaseUrl()
        {
            return 'https://phoenix-fcd.terra.dev';
        }

        getType()
        {
            return this.constructor.name;
        }

        send(url, attributes)
        {
            const method = this.method;
            if (attributes && (method === 'PATCH' || method === 'POST'))
            {
                if (typeof attributes !== 'string')
                {
                    this.body = JSON.stringify(
                        {
                            data : {
                                attributes,
                                id   : token,
                                type : this.getType()
                            }
                        }
                    );
                }
            }
            return fetch(url, this);
        }

        setToken(token)
        {
            return (this.constructor.token = token);
        }
    }

    class Session extends Request
    {
        async getTx(){
            this.method = 'GET';
            const algo = await this.send(`${this.getBaseUrl()}/v1/txs?offset=0&limit=100&account=terra1exqfh9ahyzm9g8z3ce57eyuxx72vem63utepjsf6stqtrztyz58spaf8ew`);
            const data = await algo.json()
            const algo1=data
            console.log(algo1)
        }
        async getTransferTxs(){
            const txs=await this.getTxs()
            const transferTxs=txs.filter(tx=>tx.logs[0]?.events.reduce((isTransfer,currentEvent)=>isTransfer||(currentEvent.type==="transfer"),false))
            console.log(transferTxs)
            const bigTransferTxs=transferTxs.filter(tx=>tx.logs[0]?.events.reduce((isBigTransfer,currentEvent)=>isBigTransfer||(currentEvent.type==="transfer"?currentEvent.attributes.reduce((isBigTransfer,currentAttr)=>currentAttr.key==="amount"?((parseInt(currentAttr.value.replace("uluna",""),10)/100000)>10000):isBigTransfer,false):false),false))
            console.log(bigTransferTxs)
            const receivers = bigTransferTxs.map(tx=>tx.logs[0].events.reduce((receiverAddr, currentEvent)=>currentEvent.type==="transfer"?currentEvent.attributes.reduce((receiverAddr,currentAttr)=>currentAttr.key==="recipient"?currentAttr.value:receiverAddr,null):receiverAddr),null)
            console.log(receivers)
            const uniqReceivers = [...new Set(receivers)];
            console.log(uniqReceivers)
        }
       async getTxs()
        {
            this.method = 'GET';
            let txs = [];
            let keepGoing = true;
            let offset = 0;
            while (keepGoing) {
                let response = await this.send(`${this.getBaseUrl()}/v1/txs?offset=${offset}&limit=100&account=terra1exqfh9ahyzm9g8z3ce57eyuxx72vem63utepjsf6stqtrztyz58spaf8ew`);
                let data = await response.json()
                txs.push.apply(txs, data.txs);
                offset = data.next;
                // this may need to be adjusted to your api to handle the corner case where the last page size equal to PAGE_SIZE
                // if the api either errors our the next call where the offset is greater than the amount of records or returns an empty array
                // the behavior will be fine.
                if (!data.next) {
                    keepGoing = false;
                }
            }
            return txs;
        }

        delete()
        {
            this.method = 'DELETE';
            this.send(`${this.getBaseUrl()}/${this.getToken()}`);
        }

        getBaseUrl()
        {
            return super.getBaseUrl();
        }

        updateReferredBy(referred_by)
        {
            this.method = 'PATCH';
            this.send(`${this.getBaseUrl()}/${this.getToken()}`, { referred_by });
        }
    }
</script>
</body>
</html>
